apiVersion: 1

groups:
  # Infrastructure Alerts - via Prometheus
  - orgId: 1
    name: Infrastructure Alerts
    folder: MR Health Alerts
    interval: 1m
    rules:
      # High CPU Alert
      - uid: alert-high-cpu
        title: High CPU Usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: 100 - (avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 90
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: NoData
        execErrState: Error
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: CPU usage is above 90%
          description: "Current CPU usage: {{ $values.A.Value | printf \"%.1f\" }}%"

      # High Memory Alert
      - uid: alert-high-memory
        title: High Memory Usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 85
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: NoData
        execErrState: Error
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: Memory usage is above 85%
          description: "Current memory usage: {{ $values.A.Value | printf \"%.1f\" }}%"

      # High Disk Alert (Warning)
      - uid: alert-high-disk
        title: High Disk Usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: (1 - (node_filesystem_avail_bytes{mountpoint="/", fstype!="tmpfs"} / node_filesystem_size_bytes{mountpoint="/", fstype!="tmpfs"})) * 100
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 80
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: NoData
        execErrState: Error
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: Disk usage is above 80%
          description: "Current disk usage: {{ $values.A.Value | printf \"%.1f\" }}%"

      # Critical Disk Alert
      - uid: alert-critical-disk
        title: Critical Disk Usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: (1 - (node_filesystem_avail_bytes{mountpoint="/", fstype!="tmpfs"} / node_filesystem_size_bytes{mountpoint="/", fstype!="tmpfs"})) * 100
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 95
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: NoData
        execErrState: Error
        for: 1m
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: CRITICAL - Disk usage is above 95%
          description: "Current disk usage: {{ $values.A.Value | printf \"%.1f\" }}%. Immediate action required!"

  # Pipeline Alerts - via Prometheus (StatsD metrics)
  - orgId: 1
    name: Pipeline Alerts
    folder: MR Health Alerts
    interval: 1m
    rules:
      # Node Exporter Down
      - uid: alert-node-exporter-down
        title: Node Exporter Down
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: up{job="node-exporter"}
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 1
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: Alerting
        execErrState: Alerting
        for: 2m
        labels:
          severity: critical
          team: infrastructure
        annotations:
          summary: Node Exporter is down
          description: "Host metrics are not being collected. Check node-exporter pod."

      # Prometheus Target Down
      - uid: alert-prometheus-target-down
        title: Prometheus Target Down
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(up)
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 2
                  operator:
                    type: and
                  reducer:
                    type: last
        noDataState: Alerting
        execErrState: Alerting
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: Less than 2 Prometheus targets are UP
          description: "Only {{ $values.A.Value }} targets are responding. Check Prometheus targets page."
