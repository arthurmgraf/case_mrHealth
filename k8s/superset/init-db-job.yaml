apiVersion: batch/v1
kind: Job
metadata:
  name: superset-init-db
  namespace: mrhealth-db
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: init-db
          image: postgres:16-alpine
          command: ["sh", "-c"]
          args:
            - |
              echo "=== Creating superset_db database ==="
              echo "Host: postgresql"
              echo "User: $PG_USER"

              # Wait for PostgreSQL to be ready
              until PGPASSWORD=$PG_PASSWORD psql -h postgresql -U $PG_USER -d postgres -c '\q' 2>/dev/null; do
                echo "Waiting for PostgreSQL..."
                sleep 2
              done

              # Check if database exists
              if PGPASSWORD=$PG_PASSWORD psql -h postgresql -U $PG_USER -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = 'superset_db'" | grep -q 1; then
                echo "Database superset_db already exists!"
              else
                echo "Creating database superset_db..."
                PGPASSWORD=$PG_PASSWORD psql -h postgresql -U $PG_USER -d postgres -c "CREATE DATABASE superset_db;"
                echo "Database created successfully!"
              fi

              # Verify database
              PGPASSWORD=$PG_PASSWORD psql -h postgresql -U $PG_USER -d superset_db -c '\conninfo'
              echo "=== Database ready for Superset ==="
          env:
            - name: PG_USER
              value: "mrhealth_admin"
            - name: PG_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-secret
                  key: postgres-password
