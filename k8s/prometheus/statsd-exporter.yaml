apiVersion: v1
kind: ConfigMap
metadata:
  name: statsd-exporter-config
  namespace: mrhealth-db
  labels:
    app: statsd-exporter
    part-of: mrhealth
data:
  statsd-mapping.yml: |
    mappings:
      # Airflow DAG metrics
      - match: "airflow.dag.*.*.duration"
        name: "airflow_dag_task_duration_seconds"
        labels:
          dag_id: "$1"
          task_id: "$2"

      - match: "airflow.dagrun.duration.*.*.success"
        name: "airflow_dagrun_duration_success_seconds"
        labels:
          dag_id: "$1"
          run_id: "$2"

      - match: "airflow.dagrun.duration.*.*.failed"
        name: "airflow_dagrun_duration_failed_seconds"
        labels:
          dag_id: "$1"
          run_id: "$2"

      - match: "airflow.dag_processing.total_parse_time"
        name: "airflow_dag_processing_total_parse_time_seconds"

      - match: "airflow.scheduler.tasks.running"
        name: "airflow_scheduler_tasks_running"

      - match: "airflow.scheduler.tasks.starving"
        name: "airflow_scheduler_tasks_starving"

      - match: "airflow.ti.start.*.*"
        name: "airflow_task_instance_started_total"
        labels:
          dag_id: "$1"
          task_id: "$2"

      - match: "airflow.ti.finish.*.*.*"
        name: "airflow_task_instance_finished_total"
        labels:
          dag_id: "$1"
          task_id: "$2"
          state: "$3"

      # Default catch-all for other Airflow metrics
      - match: "airflow.*"
        name: "airflow_${1}"
        labels:
          airflow_metric: "$1"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: statsd-exporter
  namespace: mrhealth-db
  labels:
    app: statsd-exporter
    part-of: mrhealth
spec:
  replicas: 1
  selector:
    matchLabels:
      app: statsd-exporter
  template:
    metadata:
      labels:
        app: statsd-exporter
        part-of: mrhealth
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9102"
    spec:
      containers:
        - name: statsd-exporter
          image: prom/statsd-exporter:v0.26.0
          args:
            - '--statsd.listen-udp=:9125'
            - '--statsd.listen-tcp=:9125'
            - '--web.listen-address=:9102'
            - '--statsd.mapping-config=/etc/statsd-exporter/statsd-mapping.yml'
          ports:
            - containerPort: 9125
              protocol: UDP
              name: statsd-udp
            - containerPort: 9125
              protocol: TCP
              name: statsd-tcp
            - containerPort: 9102
              protocol: TCP
              name: metrics
          volumeMounts:
            - name: config
              mountPath: /etc/statsd-exporter
              readOnly: true
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
          livenessProbe:
            httpGet:
              path: /metrics
              port: 9102
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /metrics
              port: 9102
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: config
          configMap:
            name: statsd-exporter-config
---
apiVersion: v1
kind: Service
metadata:
  name: statsd-exporter
  namespace: mrhealth-db
  labels:
    app: statsd-exporter
    part-of: mrhealth
spec:
  type: ClusterIP
  selector:
    app: statsd-exporter
  ports:
    - port: 9125
      targetPort: 9125
      protocol: UDP
      name: statsd-udp
    - port: 9125
      targetPort: 9125
      protocol: TCP
      name: statsd-tcp
    - port: 9102
      targetPort: 9102
      protocol: TCP
      name: metrics
